#!/usr/bin/env bash
set -euo pipefail

# Existing behavior
if [[ ${GO_PROXY_PAT:-} ]]; then
  echo "machine goproxy.githubapp.com login nobody password $GO_PROXY_PAT" >> "$HOME/.netrc"
fi

# --- Copilot playbook sync into github/github Codespaces (track main; add-only) ---
PLAYBOOK_REPO_URL="https://github.com/github/eggyhead-copilot-playbook.git"
PLAYBOOK_BRANCH="main"
PLAYBOOK_CACHE_DIR="${HOME}/.local/share/copilot-playbooks/github-eggyhead-copilot-playbook"

WORKSPACE_GITHUB_DIR="/workspaces/github"
DEST_ROOT="${WORKSPACE_GITHUB_DIR}/.copilot"
DEST_GITHUB_DIR="${DEST_ROOT}/github"

sync_playbook_add_only() {
  mkdir -p "$(dirname "$PLAYBOOK_CACHE_DIR")"

  if [[ -d "$PLAYBOOK_CACHE_DIR/.git" ]]; then
    git -C "$PLAYBOOK_CACHE_DIR" fetch --quiet origin
  else
    rm -rf "$PLAYBOOK_CACHE_DIR"
    git clone --quiet "$PLAYBOOK_REPO_URL" "$PLAYBOOK_CACHE_DIR"
  fi

  # Track main
  git -C "$PLAYBOOK_CACHE_DIR" checkout --quiet "$PLAYBOOK_BRANCH"
  git -C "$PLAYBOOK_CACHE_DIR" pull --ff-only --quiet origin "$PLAYBOOK_BRANCH"

  # Ensure destination exists
  mkdir -p "$DEST_GITHUB_DIR"

  # Add-only copy: copy files that do not exist in destination yet.
  # This copies ONLY the playbook repo's `github/` directory contents.
  local src="${PLAYBOOK_CACHE_DIR}/github"

  if [[ ! -d "$src" ]]; then
    echo "Copilot playbook repo does not contain a github/ directory at ${src}"
    return 0
  fi

  # Create directories in destination to match source
  # (safe even if they already exist)
  while IFS= read -r -d '' dir; do
    rel="${dir#"$src"/}"
    mkdir -p "${DEST_GITHUB_DIR}/${rel}"
  done < <(find "$src" -type d -print0)

  # Copy new files only
  while IFS= read -r -d '' file; do
    rel="${file#"$src"/}"
    dest_file="${DEST_GITHUB_DIR}/${rel}"

    if [[ -e "$dest_file" ]]; then
      # add-only: do not overwrite
      continue
    fi

    mkdir -p "$(dirname "$dest_file")"
    cp -p "$file" "$dest_file"
  done < <(find "$src" -type f -print0)

  # Ensure a stable entrypoint README exists (add-only)
  if [[ ! -e "${DEST_ROOT}/README.md" ]]; then
    cat > "${DEST_ROOT}/README.md" <<'EOF'
# Copilot playbook (workspace-local)

This folder is populated by your dotfiles on Codespace startup from:
- https://github.com/github/eggyhead-copilot-playbook (branch: main)
- specifically its `github/` folder

Start here:
- github/docs/annoyances-and-workflow.md
- github/docs/how-i-built-this.md
- github/docs/summary-and-testing-plan.md
- github/metadata/dotcom-test-modes.metadata.yml
- github/instructions/dotcom-test-modes.instructions.md
- github/instructions/copilot-quality.instructions.md

Tip:
Open the relevant instruction file and paste key rules into Copilot Chat at session start,
or attach the file as context.
EOF
  fi

  echo "Copilot playbook: added any missing files into ${DEST_ROOT}"
}

# --- Copy instructions + metadata into repo-local untracked folders (add-only) ---
# Why: github/github already has .github/instructions/, and we don't want collisions or tracked changes.
# We place local-only files under:
#   .github/instructions.local/
#   .github/metadata.local/
sync_repo_local_guidance_add_only() {
  local repo_dotgithub="${WORKSPACE_GITHUB_DIR}/.github"
  local dest_instructions="${repo_dotgithub}/instructions.local"
  local dest_metadata="${repo_dotgithub}/metadata.local"

  local src_instructions="${DEST_GITHUB_DIR}/instructions"
  local src_metadata="${DEST_GITHUB_DIR}/metadata"

  mkdir -p "$dest_instructions" "$dest_metadata"

  # Copy instruction files (add-only)
  if [[ -d "$src_instructions" ]]; then
    while IFS= read -r -d '' file; do
      local base dest
      base="$(basename "$file")"
      dest="${dest_instructions}/${base}"

      [[ -e "$dest" ]] && continue
      cp -p "$file" "$dest"
    done < <(find "$src_instructions" -maxdepth 1 -type f -name '*.instructions.md' -print0)
  fi

  # Copy metadata files (add-only)
  if [[ -d "$src_metadata" ]]; then
    while IFS= read -r -d '' file; do
      local base dest
      base="$(basename "$file")"
      dest="${dest_metadata}/${base}"

      [[ -e "$dest" ]] && continue
      cp -p "$file" "$dest"
    done < <(find "$src_metadata" -maxdepth 1 -type f \( -name '*.yml' -o -name '*.yaml' \) -print0)
  fi

  # Add a tiny README to help discoverability (add-only)
  if [[ ! -e "${dest_instructions}/README.md" ]]; then
    cat > "${dest_instructions}/README.md" <<'EOF'
# Local Copilot instructions (untracked)

This folder is populated by dotfiles on Codespace startup.

Copilot will not automatically apply these just because they exist on disk.
To use them, attach/paste the relevant instruction file into Copilot Chat.

Related metadata lives in: ../metadata.local/
EOF
  fi

  # Keep them untracked without touching repo .gitignore (global exclude)
  local git_global_excludes="${HOME}/.config/git/ignore"
  mkdir -p "$(dirname "$git_global_excludes")"
  touch "$git_global_excludes"

  # Add-only append to global excludes
  grep -qxF '.github/instructions.local/' "$git_global_excludes" || echo '.github/instructions.local/' >> "$git_global_excludes"
  grep -qxF '.github/metadata.local/' "$git_global_excludes" || echo '.github/metadata.local/' >> "$git_global_excludes"
}

# Only run in Codespaces where the github/github workspace exists.
if [[ -d "$WORKSPACE_GITHUB_DIR" ]]; then
  sync_playbook_add_only || echo "Copilot playbook sync failed (non-fatal)."
  sync_repo_local_guidance_add_only || echo "Repo-local guidance sync failed (non-fatal)."
fi

# --- Ensure ~/.bash_aliases is installed and sourced ---
# This makes aliases available in new Codespaces (bash).
DOTFILES_DIR="$(cd "$(dirname "$0")" && pwd)"

# Install ~/.bash_aliases (symlink preferred)
if [[ -f "${DOTFILES_DIR}/.bash_aliases" && ! -e "${HOME}/.bash_aliases" ]]; then
  ln -s "${DOTFILES_DIR}/.bash_aliases" "${HOME}/.bash_aliases"
fi

# Ensure bash sources ~/.bash_aliases (idempotent)
if [[ -f "${HOME}/.bashrc" ]] && ! grep -q 'bash_aliases' "${HOME}/.bashrc"; then
  cat >> "${HOME}/.bashrc" <<'EOF'

# Load user aliases (dotfiles)
if [ -f ~/.bash_aliases ]; then
  source ~/.bash_aliases
fi
EOF
fi
